# Правила поведения для проекта HomePlanner

Документ фиксирует обязательные правила разработки и эксплуатации в текущем репозитории. Все пункты обязательны к соблюдению. Язык документа: русский.

## Виртуальное окружение (venv)
- Всегда используем только уже существующее виртуальное окружение проекта.
- Стандарт и единственное допустимое расположение venv в этом репозитории — директория `.venv` в корне проекта.
- Запрещено удалять, пересоздавать или создавать новое venv без явной команды владельца проекта.
- Установка, обновление и удаление Python‑зависимостей выполняются только в существующее venv и только по явной команде владельца.
- Предпочитаемый менеджер — `uv` (если он уже установлен и привязан к текущему venv). Разрешено использовать `pip` только по явной команде.
- Любые команды управления зависимостями (установка/обновление) требуют явного подтверждения от владельца.

## Запуск серверных компонентов
- **Запрет на автоматический запуск**: Backend ВСЕГДА запускается только вручную пользователем. Автоматический запуск backend запрещен.
- Backend запускается из корня репозитория, используя существующее venv:
  - Единственный допустимый способ: `uv run python -m backend.main`.
  - Любые CLI‑флаги (`--host`, `--port`, `--reload` и т. п.) запрещены — сервер читает все параметры только из `common/config/settings.toml` (скопируйте из `settings.toml.template`).
- Frontend отдается как статический контент самим backend (см. `backend/main.py`). Отдельный дев‑сервер фронтенда не обязателен.
- Конфигурация задаётся только через `common/config/settings.toml` (скопируйте из `settings.toml.template`). Переменные окружения и CLI‑флаги для параметров запуска запрещены.

## Git‑операции
- Запрещены любые коммиты и пуши без явной команды владельца.
- Допустимые команды с префиксом `!`:
  - `!gc` — git commit
  - `!gcp` — git commit and push
  - `!gp` — git pull
  - `!gpr` — git pull --rebase
- Автоматические коммиты по завершении задач запрещены. Всегда дожидаться команды.

## Тестирование и качество
- Тесты запускаем только по команде владельца. В случае падений — предоставляем развёрнутый отчёт и анализ причин. Автоматические правки кода без команды запрещены.
- Фреймворк тестирования — `pytest` (+ плагины). Модуль `unittest` не использовать.
- Все тесты расположены в `./tests`, именование `test_*.py`.
- Типизация тестов обязательна. При необходимости импортируем для TYPE_CHECKING:
  - `from _pytest.capture import CaptureFixture`
  - `from _pytest.fixtures import FixtureRequest`
  - `from _pytest.logging import LogCaptureFixture`
  - `from _pytest.monkeypatch import MonkeyPatch`
  - `from pytest_mock.plugin import MockerFixture`
- Линтер — Ruff; проверка типов — mypy. Запуск через существующее venv, предпочтительно `uv run`.

## Код‑стайл и требования к Python‑коду
- Все функции и классы должны быть аннотированы типами, включая возвращаемые типы.
- Обязательны docstring‑и в формате PEP 257. При необходимости обновлять существующие docstring‑и.
- Сохранять существующие комментарии в файлах кода.
- Избегать избыточных `try/except`; не подавлять исключения без осмысленной обработки.
- Следовать конфигурации Ruff и mypy, заданной в `pyproject.toml`.

## Архитектурные принципы
- Чёткое разделение на слои: модели, схемы, сервисы, роутеры, утилиты.
- Конфигурация через файлы (`common/config/settings.toml`), см. `backend/config.py`.
- Продуманная обработка ошибок и логирование с контекстом.
- Документация: docstring‑и и файлы в `docs/`, README актуален.
- CI/CD — GitHub Actions/GitLab CI (при наличии), без самовольных изменений конфигов.

## Правила ведения документации
- **Актуальные документы** находятся в директории `docs/` и должны поддерживаться в актуальном состоянии.
- **Архивные документы** находятся в директории `docs/archive/` и **запрещено обновлять или изменять** их содержимое после перемещения в архив.
- **Важно:** Документ должен находиться только в одном месте — либо в `docs/`, либо в `docs/archive/`. Дублирование запрещено.
- Если документ актуален и требуется для текущей работы — он должен быть в `docs/`.
- В архив (`docs/archive/`) отправляются только полностью завершённые и отработанные документы, которые больше не потребуются для текущей разработки.
- При завершении работы над планом/документом:
  - Обновить финальный статус и дату завершения в самом документе.
  - Переместить документ из `docs/` в `docs/archive/` после завершения всех этапов.
  - Убедиться, что в `docs/` не осталось дубликата файла.
  - Обновить ссылки в других документах, указывающие на перемещённый документ (с указанием `archive/` в пути).
  - После перемещения в архив документ считается исторической записью и не изменяется.
- Документы, описывающие текущие процессы или активные планы, остаются в `docs/` и регулярно обновляются.
- При упоминании архивных документов в других местах всегда указывать полный путь с `archive/` (например, `docs/archive/MIGRATION_TO_LOCAL_API.md`).

## Android сборка
- Каждая сборка Android приложения должна происходить с новым значением patch версии.
- Сборка осуществляется исключительно через скрипт `android/build.sh` с флагами `--debug` или `--release`.
- Patch версия увеличивается автоматически после успешной сборки через build.sh.
- Запрещено фиксировать patch версию или использовать одинаковые версии для разных сборок.

## Общие правила запуска команд
- Все команды (Python, uv, Gradle, alembic и т.п.) **запускаются только из корня репозитория**.
- Во всех инструкциях и скриптах используются **относительные пути от корня проекта** (например, `python -m backend.main`, `android\\gradlew.bat :app:connectedAndroidTest`).
- Команда `cd` для перехода в подкаталоги в интерактивных сессиях и автоматизированных сценариях **не используется**.
- Если нужно обратиться к файлам/подпроектам, путь всегда указывается явно: `backend/...`, `android/...`, `common/config/...` и т.д.

## Команды проекта с префиксом `&`
- Допускается поддерживать краткие команды проекта (алиасы) с префиксом `&`, документируя их здесь. При добавлении — требуется явное одобрение владельца.

---
Последнее обновление: хранить этот файл в актуальном состоянии при изменении договорённостей. Изменения — только с одобрения владельца проекта.
