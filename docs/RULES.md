# Правила поведения для проекта HomePlanner

Документ фиксирует обязательные правила разработки и эксплуатации в текущем репозитории. Все пункты обязательны к соблюдению. Язык документа: русский.

## Виртуальное окружение (venv)
- Всегда используем только уже существующее виртуальное окружение проекта.
- Стандарт и единственное допустимое расположение venv в этом репозитории — директория `.venv` в корне проекта.
- Запрещено удалять, пересоздавать или создавать новое venv без явной команды владельца проекта.
- Установка, обновление и удаление Python‑зависимостей выполняются только в существующее venv и только по явной команде владельца.
- Предпочитаемый менеджер — `uv` (если он уже установлен и привязан к текущему venv). Разрешено использовать `pip` только по явной команде.
- Любые команды управления зависимостями (установка/обновление) требуют явного подтверждения от владельца.

## Запуск серверных компонентов
- Backend запускается из корня репозитория, используя существующее venv:
  - Единственный допустимый способ: `uv run python -m backend.main`.
  - Любые CLI‑флаги (`--host`, `--port`, `--reload` и т. п.) запрещены — сервер читает все параметры только из `common/config/settings.toml` (скопируйте из `settings.toml.template`).
- Frontend отдается как статический контент самим backend (см. `backend/main.py`). Отдельный дев‑сервер фронтенда не обязателен.
- Конфигурация задаётся только через `common/config/settings.toml` (скопируйте из `settings.toml.template`). Переменные окружения и CLI‑флаги для параметров запуска запрещены.

## Git‑операции
- Запрещены любые коммиты и пуши без явной команды владельца.
- Допустимые команды с префиксом `!`:
  - `!gc` — git commit
  - `!gcp` — git commit and push
  - `!gp` — git pull
  - `!gpr` — git pull --rebase
- Автоматические коммиты по завершении задач запрещены. Всегда дожидаться команды.

## Тестирование и качество
- Тесты запускаем только по команде владельца. В случае падений — предоставляем развёрнутый отчёт и анализ причин. Автоматические правки кода без команды запрещены.
- Фреймворк тестирования — `pytest` (+ плагины). Модуль `unittest` не использовать.
- Все тесты расположены в `./tests`, именование `test_*.py`.
- Типизация тестов обязательна. При необходимости импортируем для TYPE_CHECKING:
  - `from _pytest.capture import CaptureFixture`
  - `from _pytest.fixtures import FixtureRequest`
  - `from _pytest.logging import LogCaptureFixture`
  - `from _pytest.monkeypatch import MonkeyPatch`
  - `from pytest_mock.plugin import MockerFixture`
- Линтер — Ruff; проверка типов — mypy. Запуск через существующее venv, предпочтительно `uv run`.

## Код‑стайл и требования к Python‑коду
- Все функции и классы должны быть аннотированы типами, включая возвращаемые типы.
- Обязательны docstring‑и в формате PEP 257. При необходимости обновлять существующие docstring‑и.
- Сохранять существующие комментарии в файлах кода.
- Избегать избыточных `try/except`; не подавлять исключения без осмысленной обработки.
- Следовать конфигурации Ruff и mypy, заданной в `pyproject.toml`.

## Архитектурные принципы
- Чёткое разделение на слои: модели, схемы, сервисы, роутеры, утилиты.
- Конфигурация через файлы (`common/config/settings.toml`), см. `backend/config.py`.
- Продуманная обработка ошибок и логирование с контекстом.
- Документация: docstring‑и и файлы в `docs/`, README актуален.
- CI/CD — GitHub Actions/GitLab CI (при наличии), без самовольных изменений конфигов.

## Операционные ограничения
- Нельзя устанавливать, удалять или модифицировать venv и пакеты без прямого указания владельца.
- Нельзя менять менеджер зависимостей без согласования.
- Любые разрушающие действия (миграции БД, очистка данных и т. п.) — только по явной команде.

## Команды проекта с префиксом `&`
- Допускается поддерживать краткие команды проекта (алиасы) с префиксом `&`, документируя их здесь. При добавлении — требуется явное одобрение владельца.

---
Последнее обновление: хранить этот файл в актуальном состоянии при изменении договорённостей. Изменения — только с одобрения владельца проекта.
