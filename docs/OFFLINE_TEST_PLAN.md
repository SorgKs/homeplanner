## OFFLINE_TEST_PLAN

Тест‑план для проверки офлайн‑режима, синхронизации и пересчёта задач.

### 1. Группы тестов

- **Unit‑тесты**:
  - `TodayTaskFilter` (фильтрация задач по каноническим правилам);
  - `TaskDateCalculator` и функции логического дня (`getDayStart`, `isNewDay`);
  - `OfflineRepository.updateRecurringTasksForNewDay` (пересчёт по новому дню);
  - сервис пересчёта задач;
  - сценарный фасад (`TaskManager` / `TasksInteractor`).
- **Интеграционные тесты клиента**:
  - работа `SyncService` с очередью операций;
  - взаимодействие фасада с `OfflineRepository`, `SyncService`,
    сервисом пересчёта и `ReminderScheduler`.
- **Интеграционные тесты клиента + сервера**:
  - сложные сценарии с событиями за разные дни и пересчётом на обоих сторонах.
- **E2E‑/функциональные сценарии**:
  - пользовательские сценарии работы в офлайне/онлайне, с пересчётом и уведомлениями.

### 2. Каноническая проверка фильтрации задач

- На основе раздела «Канонические правила фильтрации задач» (`OFFLINE_REQUIREMENTS.md`):
  - сформировать таблицу всех комбинаций параметров:
    - тип (`one_time`, `recurring`, `interval`),
    - `completed`, `active`,
    - положение `reminder_time` (`PAST`, `TODAY`, `FUTURE`),
    - целевая вкладка («Сегодня», «Все задачи»),
    - ожидаемый флаг `visible`.
  - Для каждой строки таблицы:
    - проверить, что реализация фильтрации на бэкенде и на клиенте даёт одинаковый результат.
- На бэкенде (`tests/test_task_service.py`):
  - добавить тесты для `get_tasks_for_today()` с покрытием всех строк таблицы.
- На клиенте (`TodayTaskFilterTest`):
  - аналогично покрыть те же комбинации.

### 3. Тесты логического дня и пересчёта

- Для `TaskDateCalculator` и сервиса пересчёта задач:
  - тесты `getDayStart` и `isNewDay` для разных значений `day_start_hour`
    и граничных моментов (полночь и т.п.);
  - сценарии с пропущенными днями (пересчёт сразу к текущему логическому дню);
  - изменение `day_start_hour` вперёд/назад и влияние на пересчёт;
  - проверка инвариантов после пересчёта (см. `OFFLINE_REQUIREMENTS.md`).

### 4. Тесты синхронизации и конфликта изменений

- **SyncService**:
  - отправка очереди операций с корректными `timestamp` в хронологическом порядке;
  - поведение при пустой очереди и при отсутствии сети;
  - повторная синхронизация после восстановления сети.
- **Сложные сценарии** (интеграция клиент + сервер):
  - события только за предыдущий день + наступление нового дня;
  - события только за текущий день (без пересчёта);
  - события за несколько дней подряд с пересчётом между ними;
  - события до и после пересчёта на сервере (по `timestamp`);
  - офлайн‑пересчёт + последующая синхронизация.
- **Флаг `changed`**:
  - случаи, когда он должен устанавливаться (изменения с других устройств, бизнес‑логика сервера);
  - случаи, когда он не должен устанавливаться (только пересчёт нового дня);
  - поведение после явного подтверждения изменений пользователем.

### 5. Тесты уведомлений и UX

- Уведомления:
  - срабатывают в офлайне для задач с будущими `reminder_time`;
  - не планируются для завершённых задач;
  - перепланируются после пересчёта по новому дню;
  - корректно обрабатывают повторяющиеся и интервальные задачи.
- UX‑сценарии:
  - отображение задач во вкладках «Сегодня»/«Все задачи» в офлайне;
  - работа приложения при быстром переключении офлайн/онлайн;
  - поведение при большом количестве задач и операций (нагрузочные сценарии).

### 6. Критерии готовности

- Все описанные группы тестов реализованы и проходят.
- Покрытие ключевых новых компонентов (фильтрация, пересчёт, синхронизация, уведомления) не ниже целевого
  порога (например, 80%).
- Нет регрессий в онлайн‑режиме и базовом UX.

{
  "cells": [],
  "metadata": {
    "language_info": {
      "name": "python"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 2
}