# –ö—Ä–∏—Ç–∏–∫–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –ø–ª–∞–Ω—É —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ WebSocket

> **–î–∞—Ç–∞:** 2025-12-27  
> **–†–µ—Ü–µ–Ω–∑–µ–Ω—Ç:** AI Assistant  
> **–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏  
> **–ò–∑—É—á–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:** `WEBSOCKET_REFACTORING_PLAN.md`, `MIGRATION_TO_LOCAL_API.md`, –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ LocalApi –∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã**:

1. ‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:** UI –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Flow –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∫—ç—à–µ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `mutableStateOf` —Å —è–≤–Ω—ã–º –≤—ã–∑–æ–≤–æ–º `updateUIFromCacheLocal()`
2. ‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:** `calculateTasksHash()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ MainActivity –∏ SyncService ‚Äî –Ω—É–∂–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞
3. ‚úÖ **–ù–∞–π–¥–µ–Ω–æ:** `SyncService.syncCacheWithServer()` —É–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ö–µ—à–µ–π ‚Äî –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è hash_check
4. ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `syncService: SyncService` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WebSocketService

**–û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≠—Ç–∞–ø 0 (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Flow) –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≠—Ç–∞–ø 5 –ø–µ—Ä–µ–¥ –≠—Ç–∞–ø–æ–º 4.

## –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

–ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ü–µ–ª–æ–º **—Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –ø—Ä–æ–¥—É–º–∞–Ω**, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤** –∏ **–Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–µ—Ç–∞–ª–µ–π**, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ LocalApi (`MIGRATION_TO_LOCAL_API.md`) —Å—Ç–∞–ª–æ —è—Å–Ω–æ, —á—Ç–æ —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥—Ö–æ–¥, –≥–¥–µ UI —è–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `updateUIFromCacheLocal()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Flow. –≠—Ç–æ **–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** –ø—Ä–æ–±–ª–µ–º—ã —Å –≠—Ç–∞–ø–æ–º 5.

**–û—Ü–µ–Ω–∫–∞:** ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) ‚Äî —Ö–æ—Ä–æ—à–∏–π –ø–ª–∞–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –≠—Ç–∞–ø 5 ‚Äî UI –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∫—ç—à–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–ª–∞–Ω –≥–æ–≤–æ—Ä–∏—Ç "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è", –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç: **–≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ UI –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Flow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∫—ç—à–µ–º**.

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∫–æ–¥–æ–º):**
- UI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `var allTasks by remember { mutableStateOf<List<Task>>(emptyList()) }`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —è–≤–Ω–æ —á–µ—Ä–µ–∑ `updateUIFromCacheLocal()`, –∫–æ—Ç–æ—Ä–∞—è:
  1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –∫—ç—à–∞ —á–µ—Ä–µ–∑ `offlineRepository.loadTasksFromCacheLocal()`
  2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ö–µ—à–∏ UI –∏ –∫—ç—à–∞
  3. –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —É—á—ë—Ç–æ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  4. –û–±–Ω–æ–≤–ª—è–µ—Ç `allTasks` –Ω–∞–ø—Ä—è–º—É—é
- `TaskCacheDao.getAllTasks()` —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Flow<List<TaskCache>>`, –Ω–æ UI –µ–≥–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç**
- –í `MainActivity.loadTasksFromCacheLocal()` –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —è–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `updateUIFromCacheLocal()`

**–†–∏—Å–∫:**
–ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ WebSocket –≤ —Å–µ—Ä–≤–∏—Å, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI, —Ç–æ UI **–ù–ï –ë–£–î–ï–¢ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —á–µ—Ä–µ–∑ WebSocket, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. WebSocket –æ–±–Ω–æ–≤–∏—Ç –∫—ç—à —á–µ—Ä–µ–∑ `OfflineRepository.saveTasksToCacheLocal()`
2. –ù–æ UI –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –∫—ç—à–µ
3. UI –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º –¥–æ —è–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `updateUIFromCacheLocal()`

**–†–µ—à–µ–Ω–∏–µ:**
–≠—Ç–∞–ø 5 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ú –∏ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ú**, –∞ –Ω–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º. –ù—É–∂–Ω–æ:

1. **–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤ OfflineRepository:**
   ```kotlin
   fun observeTasks(): Flow<List<Task>> {
       return taskCacheDao.getAllTasks().map { cacheList ->
           cacheList.map { it.toTask() }
       }
   }
   ```

2. **–ò–∑–º–µ–Ω–∏—Ç—å MainActivity –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Flow:**
   ```kotlin
   val allTasks by offlineRepository.observeTasks()
       .collectAsState(initial = emptyList())
   ```

3. **–£–¥–∞–ª–∏—Ç—å —è–≤–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI** (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≠—Ç–∞–ø 5 **–ü–ï–†–ï–î** –≠—Ç–∞–ø–æ–º 4, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –Ω–µ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º WebSocketService

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –≠—Ç–∞–ø–µ 3 –Ω–µ —É–∫–∞–∑–∞–Ω–æ, **–∫–∞–∫–æ–π CoroutineScope –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** –¥–ª—è WebSocketService.

**–†–∏—Å–∫:**
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CoroutineScope(Dispatchers.Main)` ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å —É–Ω–∏—á—Ç–æ–∂–µ–Ω –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —ç–∫—Ä–∞–Ω–∞
- –ï—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π Scope –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∂–∏–∑–Ω–µ–Ω–Ω–æ–º—É —Ü–∏–∫–ª—É ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `rememberCoroutineScope()` –∏–∑ MainActivity ‚Äî –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ MainActivity —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞

**–¢–µ–∫—É—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ –≠—Ç–∞–ø–µ 4:**
```kotlin
val webSocketService = remember(context, offlineRepository, reminderScheduler, networkConfig) {
    // ...
}
LaunchedEffect(webSocketService) {
    webSocketService?.start()
    // ...
}
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ WebSocketService –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∏ –µ–≥–æ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∂–∏–∑–Ω–µ–Ω–Ω–æ–º—É —Ü–∏–∫–ª—É MainActivity.

**–†–µ—à–µ–Ω–∏–µ:**
–í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π): –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Application-level scope
```kotlin
class WebSocketService(
    private val scope: CoroutineScope = CoroutineScope(Dispatchers.IO + SupervisorJob()),
    // ...
)
```

–í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ViewModel (–µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MVVM)
```kotlin
class WebSocketViewModel : ViewModel() {
    private val webSocketService = // ...
}
```

–í–∞—Ä–∏–∞–Ω—Ç 3: –°–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Application-level Service
```kotlin
class HomePlannerApplication : Application() {
    val webSocketService: WebSocketService by lazy {
        // ...
    }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 3 —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Application-level scope –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ Service –∫–ª–∞—Å—Å–∞.

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ hash_check

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–ª–∞–Ω –≥–æ–≤–æ—Ä–∏—Ç "–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ WebSocketService –∏–ª–∏ SyncService", –Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç:
1. –ö—É–¥–∞ –∏–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏?
2. –ö–∞–∫ —ç—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å SyncService?
3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å `markedChangedTaskIds` (—ç—Ç–æ UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ)?

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∫–æ–¥–æ–º):**
```kotlin
// –í MainActivity.kt
suspend fun handleHashMismatchServer(serverHash: String, currentTasks: List<Task>): Boolean {
    val newLocalHash = calculateTasksHash(currentTasks) // –†–∞–±–æ—Ç–∞–µ—Ç —Å UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º allTasks
    if (newLocalHash != serverHash) {
        markedChangedTaskIds = markedChangedTaskIds + changedIds // UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        return true // –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç loadTasksFromCacheLocal()
    }
}
```

**–í–∞–∂–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:**
1. `calculateTasksHash()` **–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è** –≤ MainActivity –∏ SyncService (–æ–±–∞ –º–µ—Ç–æ–¥–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã)
2. `SyncService` —É–∂–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥ `calculateTasksHash()` –≤–Ω—É—Ç—Ä–∏ (private)
3. `SyncService.syncCacheWithServer()` —É–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ö–µ—à–µ–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
4. `markedChangedTaskIds` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è UI –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
1. **–í—ã–Ω–µ—Å—Ç–∏ `calculateTasksHash()` –≤ —É—Ç–∏–ª–∏—Ç—É:**
   ```kotlin
   object TaskHashUtils {
       fun calculateTasksHash(tasks: List<Task>): String {
           // –ö–æ–¥ –∏–∑ SyncService.calculateTasksHash()
       }
   }
   ```
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ SyncService –∏ WebSocketService.

2. **Hash check –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å SyncService.syncCacheWithServer():**
   ```kotlin
   // –í WebSocketService.handleHashCheck()
   private suspend fun handleHashCheck(serverHash: String) {
       val cachedTasks = offlineRepository.loadTasksFromCacheLocal()
       val cachedHash = TaskHashUtils.calculateTasksHash(cachedTasks)
       if (cachedHash != serverHash) {
           // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ SyncService
           syncService.syncCacheWithServer()
           // UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Flow (–ø–æ—Å–ª–µ –≠—Ç–∞–ø–∞ 5)
       }
   }
   ```

3. **`markedChangedTaskIds`** ‚Äî —ç—Ç–æ UI-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞. –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Flow –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –µ—ë –º–æ–∂–Ω–æ:
   - –õ–∏–±–æ —É–±—Ä–∞—Ç—å (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
   - –õ–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ MainActivity –¥–ª—è UI –ª–æ–≥–∏–∫–∏ (–Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å WebSocket)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 2 –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ hash_check —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å SyncService.

---

## –í–∞–∂–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–µ—Ç–∞–ª–∏

### ‚ö†Ô∏è –î–µ—Ç–∞–ª—å 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ –æ–ø–∏—Å–∞–Ω–æ, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª –∑–∞–¥–∞—á—É –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- –ü—Ä–∏—Ö–æ–¥–∏—Ç WebSocket —Å–æ–±—ã—Ç–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–π –∂–µ –∑–∞–¥–∞—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
–í `updateUIFromCacheLocal()` –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞:
```kotlin
if (currentTask.completed != cachedTask.completed || 
    currentTask.active != cachedTask.active) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
    currentTask
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–ù—É–∂–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:
1. –°–µ—Ä–≤–µ—Ä ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (–≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞)
2. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
3. –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—á–µ—Ä–µ–¥—å –æ—á–∏—Å—Ç–∏—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

–ò–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å, —á—Ç–æ —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ UI, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫—ç—à–µ–º —á–µ—Ä–µ–∑ Flow.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 2 —Ä–∞–∑–¥–µ–ª –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

---

### ‚ö†Ô∏è –î–µ—Ç–∞–ª—å 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CoroutineScope –≤ WebSocketService

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í —Å—Ç—Ä—É–∫—Ç—É—Ä–µ WebSocketService —É–∫–∞–∑–∞–Ω–æ:
```kotlin
private var scope: CoroutineScope? = null
```

–ù–æ –Ω–µ –æ–ø–∏—Å–∞–Ω–æ:
- –ö–∞–∫ –∏ –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å scope?
- –ö–∞–∫ –∏ –∫–æ–≥–¥–∞ –æ—Ç–º–µ–Ω—è—Ç—å scope?
- –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–∞?
- –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º MainActivity?

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ MainActivity:**
WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ `LaunchedEffect(networkConfig)`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `rememberCoroutineScope()` –∏–∑ MainActivity. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ MainActivity WebSocket —Ç–æ–∂–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
–£—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –≤ –≠—Ç–∞–ø–µ 4 WebSocketService —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `remember()` –≤ MainActivity, –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

**–í–∞—Ä–∏–∞–Ω—Ç 1 (–ø—Ä–æ—Å—Ç–æ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–ª–∞–Ω—É):**
```kotlin
class WebSocketService(...) {
    private var connectionJob: Job? = null
    private val scope = CoroutineScope(Dispatchers.IO + SupervisorJob())
    
    suspend fun start() {
        connectionJob?.cancel()
        connectionJob = scope.launch { connectWebSocket() }
    }
    
    suspend fun stop() {
        connectionJob?.cancel()
        webSocket?.close(1000, "Stopped")
        webSocket = null
    }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2 (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π, Application-level):**
–°–æ–∑–¥–∞—Ç—å WebSocketService –Ω–∞ —É—Ä–æ–≤–Ω–µ Application, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ MainActivity. –ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 3 –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏ –∏ —É—Ç–æ—á–Ω–∏—Ç—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è scope –∏–∑ MainActivity —á–µ—Ä–µ–∑ `rememberCoroutineScope()` (—Å —É—á—ë—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞).

---

### ‚ö†Ô∏è –î–µ—Ç–∞–ª—å 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –≠—Ç–∞–ø–µ 2 —É–∫–∞–∑–∞–Ω–æ: "–ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", –Ω–æ –Ω–µ –æ–ø–∏—Å–∞–Ω–æ:
- –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏?
- –ù—É–∂–Ω–∞ –ª–∏ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫?
- –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫:
```kotlin
private suspend fun handleTaskUpdate(action: String, taskJson: JSONObject?, taskId: Int?) {
    try {
        when (action) {
            "created", "updated" -> {
                val task = parseTask(taskJson)
                val result = offlineRepository.saveTasksToCacheLocal(listOf(task))
                result.onFailure { e ->
                    Log.e("WebSocketService", "Failed to save task to cache", e)
                    // –í–æ–∑–º–æ–∂–Ω–æ, –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                }
            }
            // ...
        }
    } catch (e: Exception) {
        Log.e("WebSocketService", "Error handling task update", e)
        // –ù–µ –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 2 –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

---

### ‚ö†Ô∏è –î–µ—Ç–∞–ª—å 4: –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ networkConfig

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –≠—Ç–∞–ø–µ 3 —Å–∫–∞–∑–∞–Ω–æ "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ networkConfig", –Ω–æ –Ω–µ –æ–ø–∏—Å–∞–Ω–æ:
- –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è networkConfig?
- –ù—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º?

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```kotlin
LaunchedEffect(networkConfig) {
    // WebSocket –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ networkConfig
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–í MainActivity:
```kotlin
LaunchedEffect(networkConfig) {
    webSocketService?.stop()
    webSocketService = if (networkConfig != null) {
        WebSocketService(context, offlineRepository, reminderScheduler, networkConfig)
    } else {
        null
    }
    webSocketService?.start()
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 4 –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å networkConfig.

---

### ‚ö†Ô∏è –î–µ—Ç–∞–ª—å 5: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ReminderScheduler

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –≠—Ç–∞–ø–µ 2 –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è:
```kotlin
val currentTasks = offlineRepository.loadTasksFromCacheLocal()
reminderScheduler.cancelAll(currentTasks)
val updatedTasks = offlineRepository.loadTasksFromCacheLocal()
reminderScheduler.scheduleForTasks(updatedTasks)
```

–≠—Ç–æ **–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ**, —Ç–∞–∫ –∫–∞–∫:
1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –¥–≤–∞–∂–¥—ã
2. –û—Ç–º–µ–Ω—è–µ–º –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞

**–†–µ—à–µ–Ω–∏–µ:**
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
```kotlin
// –î–ª—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏
reminderScheduler.cancelForTask(oldTask) // –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
reminderScheduler.scheduleForTaskIfUpcoming(newTask)

// –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è
reminderScheduler.cancelForTask(deletedTask)

// –ü–µ—Ä–µ—Å—á—ë—Ç –≤—Å–µ—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ hash_check –∏–ª–∏ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –≠—Ç–∞–ø 2 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–ª—è ReminderScheduler.

---

## –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø 0 ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–ó–∞–¥–∞—á–∏:**
1. –í—ã–Ω–µ—Å—Ç–∏ `calculateTasksHash()` –≤ —É—Ç–∏–ª–∏—Ç—É `TaskHashUtils` (–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ MainActivity –∏ SyncService)
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `TaskCacheDao.getAllTasks()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Flow (—É–∂–µ –µ—Å—Ç—å ‚úÖ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –∫–æ–¥–µ)
3. –°–æ–∑–¥–∞—Ç—å `OfflineRepository.observeTasks(): Flow<List<Task>>`:
   ```kotlin
   fun observeTasks(): Flow<List<Task>> {
       return taskCacheDao.getAllTasks().map { cacheList ->
           cacheList.map { it.toTask() }
       }
   }
   ```
4. –û–±–Ω–æ–≤–∏—Ç—å SyncService –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TaskHashUtils
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∫—ç—à–µ–º —á–µ—Ä–µ–∑ Flow

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
- ‚úÖ TaskHashUtils —Å–æ–∑–¥–∞–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ SyncService –∏ MainActivity
- ‚úÖ OfflineRepository.observeTasks() —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ UI –º–æ–∂–µ—Ç –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∫—ç—à–µ–º —á–µ—Ä–µ–∑ Flow (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ)

---

### ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2: –£—Ç–æ—á–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —ç—Ç–∞–ø–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫:**
1. **–≠—Ç–∞–ø 0** ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Flow –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, TaskHashUtils)
2. **–≠—Ç–∞–ø 1** ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ WebSocketService (—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º syncService –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
3. **–≠—Ç–∞–ø 2** ‚Äî –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º syncService –¥–ª—è hash_check)
4. **–≠—Ç–∞–ø 3** ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
5. **–≠—Ç–∞–ø 5** ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –∫—ç—à–µ–º (–ü–ï–†–ï–î –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π! –ö—Ä–∏—Ç–∏—á–Ω–æ!)
6. **–≠—Ç–∞–ø 4** ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WebSocketService –≤ MainActivity
7. **–≠—Ç–∞–ø 6** ‚Äî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
8. **–≠—Ç–∞–ø 7** ‚Äî –û—á–∏—Å—Ç–∫–∞

---

### ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "–û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases"

**Edge cases –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. WebSocket –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. WebSocket –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –æ –∑–∞–¥–∞—á–µ, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫—ç—à–µ
3. WebSocket –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –æ –∑–∞–¥–∞—á–µ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. –ö—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏—è
5. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏—è
6. WebSocket –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è

---

### ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 4: –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
5. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
6. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ —Ä–∞–±–æ—Ç—ã WebSocket.

---

### ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 5: –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É WebSocketService

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å —É—á—ë—Ç–æ–º SyncService):**
```kotlin
class WebSocketService(
    private val context: Context,
    private val offlineRepository: OfflineRepository,
    private val reminderScheduler: ReminderScheduler,
    private val syncService: SyncService, // –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è hash_check!
    private val networkConfig: NetworkConfig,
    private val scope: CoroutineScope = CoroutineScope(Dispatchers.IO + SupervisorJob())
) {
    private var webSocket: WebSocket? = null
    private var connectionJob: Job? = null
    private var reconnectDelay = 2000L
    private var shouldReconnect = true
    private val client = OkHttpClient()
    
    // –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∫ Flow –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    private val _connectionStatus = MutableStateFlow(ConnectionStatus.DISCONNECTED)
    val connectionStatus: StateFlow<ConnectionStatus> = _connectionStatus.asStateFlow()
    
    suspend fun start() { /* ... */ }
    suspend fun stop() { /* ... */ }
    fun isConnected(): Boolean = _connectionStatus.value == ConnectionStatus.CONNECTED
    
    private suspend fun connectWebSocket() { /* ... */ }
    private suspend fun handleMessage(text: String) { /* ... */ }
    private suspend fun handleTaskUpdate(action: String, taskJson: JSONObject?, taskId: Int?) { /* ... */ }
    private suspend fun handleHashCheck(serverHash: String) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç syncService.syncCacheWithServer()
    }
}

enum class ConnectionStatus {
    DISCONNECTED, CONNECTING, CONNECTED, RECONNECTING
}
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å StateFlow –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

–ï—Å–ª–∏ –≤ UI –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å WebSocket, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `StateFlow`:
```kotlin
private val _connectionStatus = MutableStateFlow(false)
val connectionStatus: StateFlow<Boolean> = _connectionStatus.asStateFlow()
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç UI –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º:
```kotlin
val wsConnected by webSocketService.connectionStatus.collectAsState()
```

---

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```kotlin
companion object {
    private const val TAG = "WebSocketService"
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
Log.d(TAG, "WebSocket message received: type=$msgType, action=$action")
Log.e(TAG, "Failed to save task to cache", e)
```

---

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω —Ä–∞–∑–¥–µ–ª —Å —Ñ–æ—Ä–º–∞—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:
```kotlin
// –§–æ—Ä–º–∞—Ç task_update:
{
    "type": "task_update",
    "action": "created" | "updated" | "deleted" | "completed" | "uncompleted",
    "task_id": 123,
    "task": { /* Task JSON */ },
    "data_hash": "..." // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}

// –§–æ—Ä–º–∞—Ç hash_check:
{
    "type": "hash_check",
    "data_hash": "..."
}
```

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–ª–∞–Ω–∞:
1. –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —á–µ—Ç–∫–∏–º–∏ —ç—Ç–∞–ø–∞–º–∏
2. –ü–æ–Ω—è—Ç–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
3. –£—á—Ç–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (OfflineRepository, ReminderScheduler)
4. –ï—Å—Ç—å —Ä–∞–∑–¥–µ–ª —Å —Ä–∏—Å–∫–∞–º–∏

### ‚ùå –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–ª–∞–Ω–∞:
1. –ù–µ —É—á—Ç—ë–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –º–æ–º–µ–Ω—Ç —Å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º UI –∑–∞ –∫—ç—à–µ–º
2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
3. –ù–µ –æ–ø–∏—Å–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ edge cases
4. –ù–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å ReminderScheduler
5. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:
1. **–ö–†–ò–¢–ò–ß–ù–û:** –î–æ–±–∞–≤–∏—Ç—å –≠—Ç–∞–ø 0 (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Flow + TaskHashUtils)
2. **–ö–†–ò–¢–ò–ß–ù–û:** –î–æ–±–∞–≤–∏—Ç—å `syncService: SyncService` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WebSocketService –¥–ª—è hash_check
3. **–í–ê–ñ–ù–û:** –£—Ç–æ—á–Ω–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º WebSocketService (scope –∏–∑ MainActivity)
4. **–í–ê–ñ–ù–û:** –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É hash_check —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º syncService.syncCacheWithServer()
5. **–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û:** –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –æ–± edge cases –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ö

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ **—Ö–æ—Ä–æ—à–∏–π –∏ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–π**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ—Ä–∞–±–æ—Ç–æ–∫** –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—á—ë—Ç–∞ —Ç–æ–≥–æ, —á—Ç–æ UI –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∑–∞ –∫—ç—à–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–æ–º—É, —á—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç —Å–≤–æ–µ–π —Ü–µ–ª–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–Ω–µ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –≤ –ø–ª–∞–Ω –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ:
1. –î–æ–±–∞–≤–∏—Ç—å –≠—Ç–∞–ø 0 (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ Flow + TaskHashUtils)
2. –î–æ–±–∞–≤–∏—Ç—å `syncService: SyncService` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ WebSocketService
3. –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º (scope –∏–∑ MainActivity)
4. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –æ–± edge cases –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-27 (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
