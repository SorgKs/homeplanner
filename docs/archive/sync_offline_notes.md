# Конспект по WebSocket и оффлайн-механизмам (HomePlanner vNext)

Документ структурирует ключевые решения и best practices для реализации синхронизации через WebSocket, оффлайн-очереди и локальных кэшей.

## 1. WebSocket-канал
- Endpoint: `/api/v0.2/tasks/stream`.
- Авторизация: JWT, токен в query-параметре `token` + подтверждающее сообщение `HELLO` с текущей `revision`.
- Типы событий: `TASK_UPDATED`, `REMINDER_DUE`, `LOCK_REFRESHED`.
- Heartbeat каждые 30 секунд; при пропуске 2 подряд соединение переустанавливается.
- Сообщения содержат поля `event_type`, `entity_id`, `revision`, `payload` (локальный формат времени).

## 2. Оффлайн-очередь клиентов
- Формат хранения: IndexedDB (web), SQLite/Room (Android).
- Максимум 100 элементов, FIFO.
- Повторная отправка: экспоненциальная задержка 1s → 3s → 9s → 27s → 2 минуты (лимит).
- После 5 неудачных попыток пользователь уведомляется и предлагает ручную синхронизацию.
- Очередь содержит snapshot сущности и `revision`.

## 3. Локальный кэш
- Хранит данные за последние 7 дней, объём ≤ 20 МБ.
- Для Android — SQLCipher + `EncryptedSharedPreferences`; для web — IndexedDB + `crypto.subtle`.
- Очистка при превышении лимита выполняется по стратегии LRU.
- Данные сохраняются в локальном формате времени без конвертации.

## 4. Разрешение конфликтов
- Soft-lock создаётся на 2 минуты при редактировании, обновляется heartbeat-сообщениями.
- При ответе 409 клиент подтягивает актуальную версию, выполняет merge допустимых полей и повторяет запрос.
- UI показывает баннер с предложением выбрать «объединить» или «перезаписать».
- Все конфликты логируются на уровне WARNING (клиент и backend).

## 5. Чек-лист внедрения
- [ ] Реализован WebSocket-клиент с heartbeat и повторными подключениям.
- [ ] Настроено persisted-хранилище очереди и кэша на обеих платформах.
- [ ] Добавлены уведомления пользователя о длительном оффлайне (>30 минут).
- [ ] Покрыты тестами: генерация событий, восстановление после оффлайна, конфликтная запись.
- [ ] Документация обновлена (`docs/SYNC_POLICY.md`, клиентские гайды).


