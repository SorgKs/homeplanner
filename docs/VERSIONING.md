# Схема версионирования HomePlanner

Единая версия проекта состоит из двух чисел `MAJOR.MINOR`. Для каждой подсистемы (backend, web, android) используется собственный patch-компонент, образуя версию `MAJOR.MINOR.PATCH`.

- `MAJOR` — несовместимые изменения архитектуры, меняется синхронно для всех подсистем.
- `MINOR` — функциональные релизы, которые должны быть доступны на всех платформах.
- `PATCH` — сервисные релизы конкретной подсистемы (например, `0.2.3` для backend).

Мажорная и минорная части задаются в JSON-конфиге `common/config/version.json`. Патч-версии хранятся в отдельных файлах компонентов (`backend/version.json`, `frontend/version.json`, `android/version.json`), чтобы каждая подсистема могла выпускать сервисные релизы независимо.

Суффиксы версий пакетов хранятся в `pyproject.toml` в секции `[tool.homeplanner.package_suffixes]` для каждого компонента (backend, frontend, android, common).

## Обновление версий

1. При повышении `MAJOR` или `MINOR`:
   - Обновите `common/config/version.json`
   - Обнулите patch-номера в конфигурациях подсистем (`backend/version.json`, `frontend/version.json`, `android/version.json`)
   - Обнулите суффиксы пакетов в `pyproject.toml` в секции `[tool.homeplanner.package_suffixes]` (backend, frontend, android, common)

2. При изменении компонента (backend, frontend, android, common):
   - Увеличьте patch в соответствующем конфиге (например, `backend/version.json` для backend)
   - Увеличьте соответствующий суффикс в `pyproject.toml` в секции `[tool.homeplanner.package_suffixes]` (например, из `.0` в `.1`, из `.1` в `.2` и т.д.)

3. Отразите изменения в changelog и профильных документах (планы, релизные заметки).

**ВАЖНО**: При каждом изменении компонента (backend, frontend, android, common) необходимо увеличивать соответствующий суффикс в `pyproject.toml`. При изменении минорной (MINOR) или мажорной (MAJOR) версии проекта все суффиксы обнуляются до `.0`.

## Версионирование API

Версия API не должна быть захардкожена в коде. Она должна быть указана в конфигурации для каждого пакета.

### Конфигурация версии API

1. **Backend**: Версия API указывается в `common/config/settings.toml` в секции `[api]`:
   ```toml
   [api]
   version = "0.2"
   ```

2. **Frontend**: Версия API должна быть указана в конфигурации фронтенда (используется при формировании URL для запросов к API).

3. **Android**: Версия API должна быть указана в конфигурации Android приложения (используется при формировании URL для запросов к API).

### Поддерживаемые версии API

Список всех поддерживаемых версий API указывается в `pyproject.toml` в секции `[tool.homeplanner.api]`:

```toml
[tool.homeplanner.api]
# Список поддерживаемых версий API
# Для поддерживаемых версий допустимы исправления багов, но не создание новых функций или удаление
supported_versions = ["0.2"]
```

### Правила для поддерживаемых версий API

Для версий API, находящихся в списке поддерживаемых, **допустимы только исправления багов**. Не допускается:
- Создание новых функций
- Удаление существующих функций
- Изменение формата данных в обратно несовместимом направлении
- Изменение поведения существующих endpoints

Все новые функции и несовместимые изменения должны быть реализованы только в новых версиях API, которые добавляются в список поддерживаемых версий.

### Проверка версии API при сборке

При сборке каждого пакета (backend, frontend, android) выполняется проверка, что используемая версия API находится в списке поддерживаемых версий в `pyproject.toml`. Если версия не поддерживается, сборка завершается с ошибкой.

**Backend**: Проверка выполняется при загрузке настроек через `backend.config.get_settings()`. Если версия API в `common/config/settings.toml` не находится в списке поддерживаемых версий, приложение не запустится.

**Frontend**: Проверка должна выполняться при сборке фронтенда (требуется реализация).

**Android**: Проверка должна выполняться при сборке Android приложения (требуется реализация).

### Обновление версии API

1. При создании новой версии API:
   - Добавьте новую версию в список `supported_versions` в `pyproject.toml`
   - Обновите документацию API для новой версии
   - Создайте новую версию endpoints (если требуется обратная совместимость)

2. При удалении поддержки старой версии API:
   - Удалите версию из списка `supported_versions` в `pyproject.toml`
   - Обновите документацию, указав дату прекращения поддержки
   - Обеспечьте достаточный срок для миграции клиентов

## Использование в коде

- Общая версия доступна через функцию `get_project_version()`.
- Функция `compose_component_version(component, patch=None)` формирует версию подсистемы; если patch не передан, берётся из конфигурации компонента.
- **ВАЖНО**: Функция синтеза полной версии для компонентов должна быть единой. Все компоненты проекта (backend, frontend, android) должны использовать функцию `compose_component_version()` из модуля `common.versioning`. Запрещено дублировать логику синтеза версии в других модулях или файлах.
- Backend использует свойство `Settings.backend_version` для получения версии компонента и `Settings.api_version_path` для получения пути версии API (например, `/api/v0.2`).
- Для проверки поддерживаемых версий API используйте функцию `get_supported_api_versions()` из модуля `common.versioning`.
- Для валидации версии API используйте функцию `validate_api_version(api_version)` из модуля `common.versioning`.


