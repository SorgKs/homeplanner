# Архитектура HomePlanner 0.2

Документ описывает целевую архитектуру релиза 0.2, включая изменения в схемах данных, API-контракты, взаимодействие компонентов и стратегию интеграционного тестирования. Все положения обязательны для реализации. Актуальность поддерживается единственным разработчиком проекта.

## 1. Обзор
- Основная цель — обеспечить кроссплатформенный планировщик задач с групповыми календарями, повторяемостью, оффлайн-доступом и уведомлениями в реальном времени.
- Архитектура строится вокруг backend-сервисов на FastAPI, SPA веб-клиента и Android-приложения. Коммуникация осуществляется через REST, WebSocket и брокер сообщений для внутренних событий.
- Конфигурация управляется через переменные окружения и `backend/config.py`. Все настройки регистрируются в `docs/DEVELOPMENT.md`.

## 2. Изменения в базе данных
- **Новые таблицы**:
  - `task_groups`: связь задач с группами пользователей. Поля: `id`, `name`, `owner_id`, `created_at`, `updated_at`.
  - `task_recurrence`: параметры повторяемости (RRULE, дата окончания). Таблица выделена отдельно, чтобы хранить сложные правила повторов (включая потенциальные исключения) и не перегружать `tasks`. Ссылка на `tasks.id` с ограничением `ON DELETE CASCADE`.
  - `task_notifications`: конфигурация напоминаний (тип, канал, смещение). Связь многие-к-одному с `tasks`.
- **Расширения существующих таблиц**:
  - `tasks`: добавлены `group_id`, `recurrence_id`, `revision`, `soft_lock_owner`, `soft_lock_expires_at`.
  - `calendars`: поле `visibility` (private/shared/public).
- **Миграции**:
  - Миграционный скрипт `alembic/versions/<timestamp>_0_2_core_changes.py` создаёт новые таблицы, добавляет индексы (`tasks_revision_idx`, `notifications_due_idx`), обновляет внешние ключи (cascade delete ограничен).
  - Требования к Rollback: перед откатом очистить `task_notifications` и `task_recurrence`. Шаги описаны в файле миграции и `docs/SYNC_POLICY.md`.

## 3. API-контракты
- **Версионирование**: новый namespace `/api/v0.2/`. Проект ещё не развёрнут в продуктиве, поэтому требования к обратной совместимости и поддержке прежних клиентов отсутствуют.
- **Основные эндпоинты**:
  - `POST /tasks`: создаёт задачу, принимает `revision=0`, может содержать блок `recurrence` и `notifications`.
  - `PUT /tasks/{id}`: требует актуальный `revision`, возвращает 409 при конфликте. Проводит merge допустимых полей по стратегии из `docs/SYNC_POLICY.md`.
  - `GET /tasks/stream`: обновлённый WebSocket, события типов `TASK_UPDATED`, `REMINDER_DUE`, `LOCK_REFRESHED`.
  - `POST /calendars/{id}/members`: управление группами, поддержка ролей owner/editor/viewer.
- **Аутентификация**: JWT + refresh, `Authorization: Bearer`. Для WebSocket токен передаётся в query `token` и подтверждается handshake-сообщением.
- **OpenAPI**: спецификация обновляется в `backend/api/openapi_0_2.yaml`; автоматическая генерация клиентов (Android, web) через `scripts/tools/generate_clients.sh`.

## 4. Компонентная архитектура
- **Backend**:
  - Модули `backend/services/task_service.py`, `backend/services/notification_service.py` расширяются обработкой повторяемых задач и ревизий.
  - `backend/routers/tasks.py` добавляет WebSocket-роут, авторизацию на основе ролей.
  - Используются очереди Celery/Redis или встроенный брокер для фоновых уведомлений и ретраев.
- **Frontend (Web)**:
  - SPA на React/Vue (фактический стек — см. `frontend/README.md`). Вводится слой `frontend/services/syncStore.ts` для работы с IndexedDB и WebSocket.
  - Компоненты календаря используют библиотеку `fullcalendar` (или аналог) с адаптером под новые API.
- **Android**:
  - Архитектура MVVM. Модуль `com.homeplanner.sync` реализует работу с очередью операций и слушает WebSocket через OkHttp.
  - `MainActivity` отображает баннеры статуса синхронизации и обновляет UI из локальной базы Room/SQLCipher.
- **Интеграция**:
  - Брокер событий (Kafka/Redis Streams) используется для отправки уведомлений и синхронизации state между сервисами. Сервис-подписчик транслирует события в WebSocket канал.
  - Логирование и метрики: Prometheus, Grafana, Sentry. Логи конфликтов и латентности агрегируются согласно `docs/SYNC_POLICY.md`.

## 5. План интеграционных тестов
- **Backend + Web**: Проверка создания/редактирования задач, получение уведомлений в UI при обновлениях через WebSocket, обработка конфликтов (получение 409, merge UI).
- **Backend + Android**: Оффлайн-сценарии (создание и очередь операций без сети), синхронное обновление при восстановлении соединения, доставка напоминаний.
- **Cross-platform**: Одновременное редактирование задачи в web и Android, валидация стратегии soft-lock и уведомлений.
- **Smoke-наборы**: три ключевых сценария для web/Android/backend должны выполняться перед этапом 3 и описаны в `docs/TESTING_CONVENTIONS.md`.

## 6. Диаграммы и визуализация
- Диаграмма компонентов обновляется в `docs/screenshots/architecture_components_0_2.png` (создать/обновить до конца недели 1 этапа 2).
- Диаграмма последовательностей WebSocket/REST взаимодействий хранится в `docs/screenshots/sync_sequence_0_2.png`.
- Линк на Miro/Figma доску: `https://miro.com/app/board/o9J_homeplanner_0_2_architecture` (права на чтение у всех участников).

## 7. Зависимости и конфигурация
- Backend использует `uv` для управления зависимостями; новые пакеты фиксируются в `pyproject.toml` и согласуются с политикой проекта.
- Переменные окружения:
  - `SYNC_WS_ENDPOINT`, `SYNC_MESSAGE_BROKER_URL`, `SYNC_P95_TARGET` (по умолчанию 3s).
  - `ANDROID_ENCRYPTION_KEY`, `WEB_INDEXEDDB_NAMESPACE` — должны быть настроены в `.env` и `.env.android`.
  - Все даты и времена в API и базе хранятся в локальном формате проекта без указания таймзоны; значения передаются клиентам без дополнительной конвертации.
- CI/CD обновляется для запуска интеграционных тестов и публикует артефакты (OpenAPI, UML) в релизных сборках.

## 8. Риски и дополнительные замечания
- Наличие единственного разработчика требует корректного тайм-менеджмента и приоритизации задач; прогресс фиксируется ежедневно в issue-трекере.
- Любые отступления от architecture-видения фиксируются через RFC-документы в каталоге `docs/rfc/`.

---
Вопросы и предложения по архитектуре оформляются через issue с меткой `architecture-0-2`. Документ пересматривается не реже одного раза в спринт.

