# Требования к аналитике HomePlanner vNext

Документ описывает события телеметрии и пользовательской аналитики, которые необходимо собирать в релизе vNext. Ответственный за актуальность: единственный разработчик (он же product owner и текущий пользователь). Все изменения фиксируются в `docs/CHANGELOG_HISTORY.md`.

## 1. Общие положения
- Источники данных: backend (API события), web-клиент, Android-клиент.
- Формат времени: локальный формат проекта без таймзоны.
- Идентификаторы пользователей и устройств псевдонимизируются перед отправкой (hash).
- События группируются по категориям: `tasks`, `sync`, `notifications`, `app_lifecycle`.
- Передача данных из клиентов выполняется пакетами (batch ≤ 20 событий) раз в 5 минут или при закрытии приложения.

## 2. Схема событий

### 2.1 tasks
| Поле | Тип | Описание |
| --- | --- | --- |
| `event_name` | str | Название события (`task_created`, `task_updated`, `task_deleted`) |
| `task_id` | uuid | Идентификатор задачи |
| `revision` | int | Ревизия после операции |
| `source` | str | Канал (`web`, `android`, `backend`) |
| `has_recurrence` | bool | Признак повторяемости |
| `timestamp_local` | str | Временная метка в локальном формате проекта |

### 2.2 sync
| Поле | Тип | Описание |
| --- | --- | --- |
| `event_name` | str | `sync_started`, `sync_completed`, `sync_failed` |
| `queue_length` | int | Длина очереди оффлайн-операций |
| `latency_ms` | int | Пороговая задержка синхронизации |
| `failure_reason` | str | Код ошибки (если применимо) |
| `timestamp_local` | str | Временная метка |

### 2.3 notifications
| Поле | Тип | Описание |
| --- | --- | --- |
| `event_name` | str | `notification_scheduled`, `notification_shown`, `notification_action` |
| `task_id` | uuid | Ссылка на задачу |
| `channel` | str | Канал доставки (`push`, `local`) |
| `lead_time_minutes` | int | Время до события |
| `timestamp_local` | str | Временная метка |

### 2.4 app_lifecycle
| Поле | Тип | Описание |
| --- | --- | --- |
| `event_name` | str | `app_opened`, `app_closed`, `app_background` |
| `app_version` | str | Версия приложения |
| `platform` | str | `web` или `android` |
| `session_duration_seconds` | int | Продолжительность сессии (для `app_closed`) |
| `timestamp_local` | str | Временная метка |

## 3. Поток обработки событий
- Клиент собирает события и помещает их в локальную очередь.
- Раз в 5 минут (или по запросу пользователя) события отправляются в backend endpoint `/api/v0.2/analytics/batch`.
- Backend валидирует payload, фиксирует его в хранилище (PostgreSQL) и публикует агрегаты в брокер сообщений.
- Дальнейшая аналитика выполняется внешним инструментом (BigQuery, Metabase или аналог) — интеграция описывается отдельно.

## 4. Политика хранения
- Backend хранит сырые события 30 дней.
- Агрегированные метрики сохраняются бессрочно.
- Удаление по запросу пользователя выполняется через endpoint `/api/v0.2/analytics/delete`.

## 5. Проверка и тестирование
- Для web и Android добавляются unit-тесты на формирование payload.
- Backend покрывается контрактными тестами на приём пачек и валидацию схемы.
- В smoke-набор включить сценарий: создание задачи → генерация событий → проверка записи в хранилище.


