<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomePlanner - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-layout">
        <header>
            <h1>üè† HomePlanner</h1>
        </header>

        <div class="content-wrapper">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">–í–∏–¥</h3>
                        <div class="view-toggle">
                            <button class="btn btn-secondary sidebar-btn active" id="view-today-btn">üìÖ –°–µ–≥–æ–¥–Ω—è</button>
                            <button class="btn btn-secondary sidebar-btn" id="view-all-btn">üìã –í—Å–µ –∑–∞–¥–∞—á–∏</button>
                            <button class="btn btn-secondary sidebar-btn" id="view-history-btn">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                            <button class="btn btn-secondary sidebar-btn" id="view-settings-btn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary sidebar-btn" id="add-task-btn">
                        <span>+</span> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                    <button class="btn btn-secondary sidebar-btn" id="add-group-btn">
                        <span>üìÅ</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>
                    
                    <div class="sidebar-section">
                        <button class="btn btn-secondary sidebar-btn" id="toggle-admin-btn">
                            <span>üîß</span> <span id="admin-mode-text">–ê–¥–º–∏–Ω —Ä–µ–∂–∏–º</span>
                        </button>
                    </div>
                    
                    <div class="sidebar-section" id="tasks-filters-section">
                        <h3 class="sidebar-title">–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="search-box">
                            <input type="text" id="tasks-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á...">
                        </div>
                        <button class="filter-btn sidebar-btn" id="tasks-filter-btn">–§–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                    
                    <div class="sidebar-section" id="history-filters-section" style="display: none;">
                        <h3 class="sidebar-title">–§–∏–ª—å—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏</h3>
                        <div class="search-box">
                            <select id="history-group-filter" style="width: 100%;">
                                <option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                            </select>
                        </div>
                        <div class="search-box">
                            <select id="history-task-filter" style="width: 100%;">
                                <option value="">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                            </select>
                        </div>
                        <div class="search-box">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">–°</label>
                            <input type="date" id="history-date-from" style="width: 100%;">
                        </div>
                        <div class="search-box">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">–ü–æ</label>
                            <input type="date" id="history-date-to" style="width: 100%;">
                        </div>
                    </div>
                </nav>
            </aside>

            <main class="main-content">
                <div id="settings-view" style="display:none;">
                    <div class="card" style="margin-bottom:16px; padding:12px;">
                        <h3 style="margin-top:0;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                            <button class="btn btn-primary" id="show-apk-qr-btn">–ü–æ–∫–∞–∑–∞—Ç—å QR –¥–ª—è APK</button>
                            <a class="btn btn-secondary" id="direct-apk-link" href="#" target="_blank" rel="noopener">–°–∫–∞—á–∞—Ç—å APK</a>
                            <div id="apk-qr" style="display:none; padding:8px; border:1px solid #ddd; border-radius:8px;"></div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <label for="apk-host-input" style="font-size:0.9em;">–•–æ—Å—Ç –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (LAN/IP:–ø–æ—Ä—Ç):</label>
                            <input id="apk-host-input" type="text" placeholder="192.168.1.10:8000" style="max-width:260px;">
                            <button class="btn btn-secondary" id="apply-apk-host">–û–±–Ω–æ–≤–∏—Ç—å QR</button>
                            <small id="apk-host-hint" style="color:#666;">–ï—Å–ª–∏ –∑–¥–µ—Å—å localhost ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –æ—Ç–∫—Ä–æ–µ—Ç —Å—Å—ã–ª–∫—É. –£–∫–∞–∂–∏—Ç–µ IP –º–∞—à–∏–Ω—ã —Å –±—ç–∫–µ–Ω–¥–æ–º.</small>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <label for="api-base-input" style="font-size:0.9em;">API Base URL (frontend):</label>
                            <input id="api-base-input" type="text" placeholder="http://localhost:8000/api/v0.2" style="min-width:320px;">
                            <button class="btn btn-secondary" id="apply-api-base">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <small style="color:#666;">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.</small>
                        </div>
                    </div>
                </div>
                <div id="tasks-list" class="items-list"></div>
            </main>
        </div>

        <!-- Task Modal -->
        <div id="task-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="task-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h2>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <input type="hidden" id="task-revision">
                    <input type="hidden" id="task-type">
                    <div class="form-group">
                        <label for="task-title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="task-title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                    </div>
                    <div class="form-group">
                        <label for="task-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="task-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="task-is-recurring">–¢–∏–ø –∑–∞–¥–∞—á–∏:</label>
                        <select id="task-is-recurring" required>
                            <option value="one_time">–†–∞–∑–æ–≤–æ–µ</option>
                            <option value="recurring">–ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∑–∞–¥–∞—á–∞ (–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)</option>
                            <option value="interval">–ó–∞–¥–∞—á–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º (–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</option>
                        </select>
                    </div>
                    <div id="recurring-fields" style="display: none;">
                        <div class="form-group">
                            <label for="task-recurrence">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ:</label>
                            <select id="task-recurrence">
                                <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                                <option value="weekdays">–ü–æ –±—É–¥–Ω—è–º</option>
                                <option value="weekends">–ü–æ –≤—ã—Ö–æ–¥–Ω—ã–º</option>
                                <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                                <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                                <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                            </select>
                        </div>
                        <div id="monthly-yearly-options" style="display: none;">
                            <div class="form-group">
                                <label>–ü—Ä–∏–≤—è–∑–∫–∞:</label>
                                <div style="display: flex; gap: 16px;">
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="monthly-yearly-binding" value="date" id="binding-date" checked>
                                        <span>–ü–æ –¥–∞—Ç–µ</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="monthly-yearly-binding" value="weekday" id="binding-weekday">
                                        <span>–ü–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏</span>
                                    </label>
                                </div>
                            </div>
                            <div id="weekday-binding-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="weekday-day">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</label>
                                    <select id="weekday-day">
                                        <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                                        <option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
                                        <option value="2">–°—Ä–µ–¥–∞</option>
                                        <option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
                                        <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option>
                                        <option value="5">–°—É–±–±–æ—Ç–∞</option>
                                        <option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="weekday-number">–ù–æ–º–µ—Ä –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –≤ –º–µ—Å—è—Ü–µ:</label>
                                    <select id="weekday-number">
                                        <option value="1">–ü–µ—Ä–≤—ã–π</option>
                                        <option value="2">–í—Ç–æ—Ä–æ–π</option>
                                        <option value="3">–¢—Ä–µ—Ç–∏–π</option>
                                        <option value="4">–ß–µ—Ç–≤–µ—Ä—Ç—ã–π</option>
                                        <option value="-1">–ü–æ—Å–ª–µ–¥–Ω–∏–π</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="weekday-time">–í—Ä–µ–º—è:</label>
                                    <input type="time" id="weekday-time" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="task-interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª:</label>
                            <input type="number" id="task-interval" min="1" value="1" placeholder="–ö–∞–∂–¥—ã–µ N –ø–µ—Ä–∏–æ–¥–æ–≤">
                        </div>
                    </div>
                    <div id="interval-fields" style="display: none;">
                        <div class="form-group">
                            <label for="task-interval-days">–ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö:</label>
                            <input type="number" id="task-interval-days" min="1" value="7" placeholder="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
                        </div>
                    </div>
                    <div class="form-group" id="due-date-field">
                        <label for="task-due-date" id="date-label">–ù–∞—á–∞–ª–æ:</label>
                        <input type="datetime-local" id="task-due-date" required>
                        <div class="quick-date-buttons" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="setQuickDate('today')">–°–µ–≥–æ–¥–Ω—è</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="setQuickDate('tomorrow')">–ó–∞–≤—Ç—Ä–∞</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="setQuickDate('monday')">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-group-id">–ì—Ä—É–ø–ø–∞:</label>
                        <select id="task-group-id">
                            <option value="">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" id="task-cancel">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Group Modal -->
        <div id="group-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="group-modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
                <form id="group-form">
                    <input type="hidden" id="group-id">
                    <div class="form-group">
                        <label for="group-name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                        <input type="text" id="group-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–ª–∏—Ç—å —Ü–≤–µ—Ç—ã">
                    </div>
                    <div class="form-group">
                        <label for="group-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="group-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" id="group-cancel">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Task History Modal -->
        <div id="history-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á–∏: <span id="history-task-title"></span></h2>
                <div id="history-content" style="max-height: 400px; overflow-y: auto;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="version.js"></script>
    <script src="config.js"></script>
    <script src="utils/todayViewFilter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
    <script>
        (function(){
            // Compute backend host for phone: prefer user input, else API_BASE_URL, else window
            function getBackendOrigin() {
                const input = document.getElementById('apk-host-input');
                const value = (input && input.value || '').trim();
                if (value) {
                    // if value already has scheme
                    if (/^https?:\/\//i.test(value)) return value.replace(/\/$/, '');
                    return window.location.protocol + '//' + value.replace(/\/$/, '');
                }
                if (typeof API_BASE_URL === 'string') {
                    const base = API_BASE_URL.replace(/\/api\/v1$/, '');
                    try { const u = new URL(base); return u.origin; } catch(_) {}
                    return base;
                }
                return window.location.origin;
            }

            function buildApkUrl() {
                const origin = getBackendOrigin();
                return origin.replace(/\/$/, '') + '/download/latest.apk';
            }

            // Initialize link and inputs
            const linkEl = document.getElementById('direct-apk-link');
            const hostInput = document.getElementById('apk-host-input');
            const apiBaseInput = document.getElementById('api-base-input');
            const storedHost = localStorage.getItem('apkHost');
            if (hostInput) {
                if (storedHost) hostInput.value = storedHost;
                else {
                    // prefill with API host:port if not localhost
                    try {
                        const api = typeof API_BASE_URL === 'string' ? new URL(API_BASE_URL) : null;
                        if (api && api.hostname !== 'localhost') hostInput.value = api.host;
                        else if (window.location.hostname !== 'localhost') hostInput.value = window.location.host.replace(/:8080$/, ':8000');
                    } catch(_) {}
                }
            }
            if (apiBaseInput) {
                const storedApi = localStorage.getItem('apiBaseUrl');
                apiBaseInput.value = storedApi || (typeof API_BASE_URL === 'string' ? API_BASE_URL : 'http://localhost:8000/api/v0.2');
            }
            let apkUrl = buildApkUrl();
            linkEl.href = apkUrl;
            const applyBtn = document.getElementById('apply-apk-host');
            if (applyBtn) applyBtn.addEventListener('click', function(){
                const v = (hostInput && hostInput.value || '').trim();
                if (v) localStorage.setItem('apkHost', v);
                apkUrl = buildApkUrl();
                linkEl.href = apkUrl;
                // regenerate QR if visible
                const qrBox = document.getElementById('apk-qr');
                if (qrBox && qrBox.style.display !== 'none') {
                    qrBox.innerHTML = '';
                    renderQr(apkUrl, qrBox);
                }
            });
            const applyApiBtn = document.getElementById('apply-api-base');
            if (applyApiBtn) applyApiBtn.addEventListener('click', function(){
                const v = (apiBaseInput && apiBaseInput.value || '').trim();
                if (v) {
                    localStorage.setItem('apiBaseUrl', v);
                    // Inform user to refresh
                    alert('API Base URL —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å.');
                }
            });
            function renderQr(url, container){
                if (window.QRCode && typeof QRCode.toCanvas === 'function') {
                    QRCode.toCanvas(url, { width: 180 }, function(err, canvas){
                        if (!err && canvas) container.appendChild(canvas);
                        else {
                            const img = new Image(); img.width = 180; img.height = 180; img.alt = 'QR code';
                            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(url);
                            container.appendChild(img);
                        }
                    });
                } else {
                    const img = new Image(); img.width = 180; img.height = 180; img.alt = 'QR code';
                    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(url);
                    container.appendChild(img);
                }
            }

            document.getElementById('show-apk-qr-btn').addEventListener('click', function(){
                const qrBox = document.getElementById('apk-qr');
                qrBox.style.display = 'block';
                qrBox.innerHTML = '';
                renderQr(apkUrl, qrBox);
            });
        })();
    </script>
</body>
</html>

